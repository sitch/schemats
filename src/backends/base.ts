import { size } from 'lodash'

import type { BuildContext } from '../compiler'
import type { Backend } from '../config'
import type { TypeDBCoreferences } from '../coreference'
import { pad_lines, pretty } from '../formatters'

export type CommentDelimiter = string
export type IndentDelimiter = string

export interface BackendContext {
  backend: Backend
  comment: CommentDelimiter
  indent: IndentDelimiter
  coreferences: TypeDBCoreferences
}

export const header = (
  { config }: BuildContext,
  { comment }: BackendContext,
): string => {
  if (!config.writeHeader) {
    return ''
  }

  return pad_lines(
    `###############################################################################

  AUTO-GENERATED FILE @ ${config.timestamp} - DO NOT EDIT!

  This file was automatically generated by schemats v.${config.version}
  $ ${config.commandFromCLI}

###############################################################################`,
    comment,
  )
}

export const coreference_banner = (
  _context: BuildContext,
  { comment, indent, coreferences: { all, error, warning } }: BackendContext,
) => {
  if (size(all) === 0) {
    return ''
  }
  return pad_lines(
    `###############################################################################
  ⛔ CRITICAL ⛔ - (${size(error)}) - Attribute Conflicts
###############################################################################
${pad_lines(pretty(error), indent)}
===============================================================================
  ⚠️ WARNING ⚠️ - (${size(warning)}) - UDT Conflicts
===============================================================================
${pad_lines(pretty(warning), indent)}
-------------------------------------------------------------------------------
  ❎ INFO ❎ - (${size(all)}) - Attribute Overlaps
-------------------------------------------------------------------------------
${pad_lines(pretty(all), indent)}
###############################################################################`,
    comment,
  )
}
